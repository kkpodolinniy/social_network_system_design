### Функциональные требования
- Просмотр ленты с постами
- Возможность создать новый пост, добавить описание и фотографии о путешествии, добавить геолокацию (место)
- Возможность лайкнуть чужой пост
- Возможность комментировать чужой пост
- Возможность подписаться на автора поста
- Поиск по постов по геопозиции/ местам
- Просмотр списка пользователей (подписок)
### Нефункциональные требования

#### Аудитория приложения
- **DAU** -- 12 000 000 (12 млн. уникальных пользователей в день через год с небольшим запасом, учитывая скорость роста)
- **Аудитория** только из стран СНГ
- **Целевая аудитория** - путешественники, люди которые отдают предпочтение активному образу жизни и путешествиям
- **Трафик** - мобильный и десктопный. Учитывая, что приложение нацелено на аудиторию социально активных людей, соотношение мобильного трафика к десктопному будет примерно 80/20 (80% приходится на мобильные устройства)

#### Особенности приложения
- **Данные** храним всегда, так как нужно иметь возможность посмотреть посты которые публиковались любое количество лет в прошлом.
- **Доступность** 99.95%, среднее время простоя в год до 4х часов.
- **Сезонность** - возможное повышение активности пользователей на новогодние/майские праздники, а также в период с начала июня и до конца августа
- Тайминги:
  - 1 секунда на подгрузку бесконечной ленты при скролле (infinity scroll)
  - 0.5 секунд на лайк и пост комментария + optimistic update на фронте
  - 1 секунда на создание нового поста
  - 1.5 секунды на поиск по геоточке
- Активность пользователей:
  - 40 лайков в сутки
  - **2** комментариев в сутки
  - **3** просмотра комментариев в сутки
  - Публикация **1** пост в день
  - **2** подписки в день
  - **1** - просмотр списка пользователей
  - **0.5** поиска по локации в день
  - просмотр **200** постов в день
- Лимиты:
  - 1000 лайков в день
  - 200 комментариев в день
  - 200 подписок в день.
  - Image size < 20 mb, перед сохранением сжимаем до 800кб
  - Количество фотографий в одном посте - до 5 шт.
  - При бесконечной подгрузкеп постов в ленте (infinity scroll) - 20 постов в батче, после чего подгружаются новые
  - Можно подписаться на 5000 человек
  - При просмотре комментариев в посте подгружаем посты отдельной ручкой, по 20 комментариев в батче

### Расчет нагрузки

#### RPS

##### Посты
- Read: 12 000 000 * 10 (200 постов по 20 постов в пачке) / 86 400  = 1389
- Write 12 000 000 * 1 / 86 400 = 138

##### Лайки
- Read: приходит вместе с постом
- Write: 12 000 000 * 40 / 86 400  = 5600

##### Комментарии
- Read: 12 000 000 * 3 / 86 400 = 417
- Write: 12 000 000 * 2 / 86 400  = 278

##### Подписка/отписка
- Read: Просматриваем вместе со списком пользователей
- Write: 12 000 000 * 2 / 86 400  = 278

##### Просмотр списка пользователей
- Read: 12.000.000 * 1  / 86400 = 138

#### Traffic

##### Посты
```json
{
"id": 123,
"description": "abcd", 
"images": ["blob", "blob", "blob", "blob", "blob"],
"comments": [
{
    "firstName": "Ivan",
    "lastName": "Cherikov",
    "avatarUrl": "https://example.com/avatar.jpg"
  }
],
"isLiked" : true, 
"likes": 1235
"location": {
	"location_id": "123asd"
	"name": "place_name"
} 
}
```

###### Write
- **JSON метаданные**: 300 байт
- **5 изображений × 800 KB**: 4,000 KB = 4 MB
- **HTTP overhead**: 2 KB
- **Итого**: **~4.002 MB на запрос**

**Traffic медиа** = 138 RPS × 4 MB = 552.3 MB/сек
**Traffic JSON и Http** = 138RPS x 2.3Кb = 317,4 Kb/сек

###### Read

**JSON структура:**

- **id**: ~10 байт
- **description**: ~50 байт (средний текст поста)
- **images**: 5 URL × ~45 байт = **225 байт**
- **comments**: 3 комментария × ~50 байт = **150 байт**
- **остальные поля**: ~100 байт
- **JSON форматирование**: ~50 байт

20 постов × 585 байт = 11,700 байт = ~11.4 KB + HTTP headers (~2 KB) = ~13.4 KB на батч)

**Traffic** = 2,778 RPS × 13.4 KB = 37.2 MB/сек

##### Комментарии
###### Write

```json
{
  "id": 123,                     // ~4 байта (int32)
  "user": {
    "firstName": "Ivan",          // ~5 байт (UTF-8)
    "lastName": "Cherikov",       // ~9 байт
    "avatarUrl": "https://..."    // ~50 байт (усреднённо)
  },
  "comment": "Trulaleo Trulala", // ~18 байт
  "created_at": "2024-08-04T12:34:56Z" // ~25 байт (ISO 8601)
}
```

**Traffic** = 278 RPS × 1.87 KB = 520 KB/сек = 0.52 MB/сек

###### Read
**Traffic** = 417 RPS×2.54 КБ=1059.18 КБ/сек= 1.03 МБ/сек​

##### Like - лайкаем посты

```json
{
"postId": 123456,
"userId": 789012,
"action": "like",
"timestamp": "2025-01-30T12:00:00Z"
}
```

Размеры: 70 байт + 1.35 KB (http headers и тд) = ~1.42 KB

###### Write
**Traffic** = 5,600 RPS × 1.42 KB = 7,952 KB/сек = 7.95 MB/сек


##### Список пользователей
```json
{
  "id": 789012,
  "firstName": "Alexander",
  "lastName": "Petrov",
  "username": "alex_petrov_2024",
  "avatar": "https://cdn.myapp.com/avatars/abc123.jpg",
  "isSubscribed": true,
  "subscription": false,
  "isOnline": true,
  "followersCount": 1250,
  "mutualFriends": 15,
  "lastSeen": "2025-01-30T11:45:00Z"
}
```


###### Read
300 пользователей × 210 байт = 63,000 байт = 63 KB + JSON массив overhead (~500 байт) = ~63.5 KB + HTTP headers (~2 KB) = ~65.5 KB на запрос

**Traffic** = 138 RPS × 65.5 KB = 9,039 KB/сек = 9.04 MB/сек

###### Write (подписаться/отписаться)
```json
{
  "subscribed": true
}
```
- **Traffic**: 37 КБ/сек



### Оценка дисков
Вводные:
- Выводим 25% на SSD диски, 75% выводим на HDD объемом 32TB для охлаждения данных
- 80% IOPS и трафика приходится на SSD, а 20% на HDD (цифры берутся примерные ). Такое разделение связано с тем, что больше всего нагрузки будет на SSD, так как эти данные будут чаще просматриваться
- Шардировать будем по key type с хэш-функцией по ключу от user_id. При этом будем охлаждать данные по дате создания поста. Все что старее 3 месяцев отправляется в холодное HDD хранилище
- Таблички связанные с пользователями и подпиской на пользователей будут всегда в SSD хранилище, так как они не привязаны к посту и в целом являются частотными - подписаться, отписать, просмотреть список подписок

##### Посты
- Read:  1389 RPS Traffic 37.2 MB/сек
- Write: 138 RPS Traffic 552.6 mb/s
- **SUM Traffic**: **589.8 MB/сек** (здесь такая большая цифра, потому можно загрузить до 5 изображений по 800кб)

**Capacity** = 552.6 mb/s x 86400 x 365 = 17.43 петабайт в год/год.

**Объем**:  17430 / 32 = 545 дисков = 136 SSD и 408 HDD дисков

**Операции ввода-вывода в секунду**:
Для SSD: - (1526 RPS x 80%)/ 1000 = 1.22 Диска
Для HDD - (1526 RPS x 20%)/ 100 = 3.05 Диска
**Пропускная способность**:  589.8 MB/сек / 500 = 1.12
Для SSD - (589.8 MB/сек x 80%) / 500 = 0.94 Диска
Для HDD - (589.8 MB/сек x 20%) / 100 = 1.17 Диска

##### Лайки
- Read: приходит вместе с постом
- Write: 5600 RPS  Traffic 7.95 MB/сек
- **SUM Traffic**: 7.95 MB/сек

**Capacity** = 7.95  mb/s x 86400 x 365 = 250.71 TB

**Объем**: 250.71 / 32TB = 7.83 (8дисков) =  3 SSD и 5 HDD дисков

**Операции ввода-вывода в секунду**:
Для SSD: - (5600 RPS x 80%)/ 1000 = 4.48 Диска
Для HDD - (5600 RPS x 20%)/ 100 = 11.2 Диска
**Пропускная способность**:  
Для SSD - (7.95MB/сек x 80%) / 500 = 0.01 Диска
Для HDD - (7.95 MB/сек x 20%) / 100 = 0.02 Диска



##### Комментарии
- Read: 417 RPS Traffic  1.03 МБ/сек​
- Write: 278 RPS Traffic  0.52 MB/сек
- **SUM Traffic**: 1.56 MB/сек

**Capacity** = 0.52 mb/s x 86400 x 365 = 16.39872 TB

**Объем**:  16.39 / 32TB - 0.51 диска = 0.13 SSD и 0.38 HDD

**Операции ввода-вывода в секунду**:
Для SSD: - (695 RPS x 80%)/ 1000 = 0.56 Диска
Для HDD - (695 RPS x 20%)/ 100 = 1.39 Диска
**Пропускная способность**:  
Для SSD - (1.56 MB/сек x 80%) / 500 = 0.002 Диска
Для HDD - (1.56 MB/сек x 20%) / 100 = 0.003 Диска



##### Пользователи
> При шардировании базы данных таблица с подписками и пользователями будет всегда в SSD, так как данные часто используются и нету необходимости охлаждать данные

- Read: 138 RPS (просмотр списка пользователей) Traffic 9.04 MB/сек
- Write: 278 RPS (подписка/отписка) Traffic 37 КБ/сек
- **SUM Traffic**: 9.41 MB/сек


**Capacity** = 37 КБ/сек  x 86400 x 365 = 1.17TB


**Объем**:  1.17 /32 = 0.04 SSD
**Операции ввода-вывода в секунду**: 416/ 1000 - 0.41  SSD
**Пропускная способность**:  9,41мб/с / 500  = 0.02 SSD

#### Считаем общее (самая большая величина по каждой подсистемы)
- 136 SSD и 408 HDD дисков для **постов**
- 4.48 SSD и 11.2 HDD дисков для лайков
- 0.56 SSD и 1.39 HDD дисков для комментариев
- 0.4 SSD диска для пользователей
  ИТОГО:
  SSD: 142 Диска
  HDD : 421 Диска

### Расчет хостов
SSD хосты: 142 SSD диска / 2 диска на хост = 71 SSD хост x 2 (репликация)  = 142 хоста
HDD хосты: 421 HDD диск / 2 диска на хост = 210.5 ≈ 211 HDD хостов  x 2 (репликация)  = 422 хоста
ИТОГО: 71 + 211 = 564 хоста

#### Расчет по подсистемам

##### Посты
SSD хосты: 136 SSD диска / 2 диска на хост = 68 SSD хост x 2 (репликация)  = 142 хоста
HDD хосты: 408 HDD диск / 2 диска на хост = 210.5 ≈ 211 HDD хостов  x 2 (репликация)  = 408 хоста

##### Лайки
SSD хосты: 4.48 SSD диска / 2 диска на хост = 68 SSD хост x 2 (репликация)  = 5 хостов
HDD хосты: 11.2 HDD  диск / 2 диска на хост = 210.5 ≈ 211 HDD хостов  x 2 (репликация)  = 12 хостов

##### Комментарии
SSD хосты: 0.56 SSD диска / 2 диска на хост = 68 SSD хост x 2 (репликация)  = 1 хост
HDD хосты: 1.39  HDD  диск / 2 диска на хост = 210.5 ≈ 211 HDD хостов  x 2 (репликация)  = 2 хостов

##### Пользователи
SSD хосты: 0.4 SSD SSD диска / 2 диска на хост = 71 SSD хост x 2 (репликация)  = 1 хост